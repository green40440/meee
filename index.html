import React, { useEffect, useState, useRef } from "react";

export default function NoMore67() {
  const [money, setMoney] = useState(() => Number(localStorage.getItem("nm67_money")) || 0);
  const [perClick, setPerClick] = useState(() => Number(localStorage.getItem("nm67_perClick")) || 1);
  const [cps, setCps] = useState(() => Number(localStorage.getItem("nm67_cps")) || 0);

  const [upgrades, setUpgrades] = useState(() => {
    const saved = localStorage.getItem("nm67_upgrades");
    try {
      return saved
        ? JSON.parse(saved)
        : {
            punchBoost: { name: "Punch Strength", count: 0, baseCost: 15, type: "click", value: 1.5 },
            autoPunch: { name: "Auto-Puncher", count: 0, baseCost: 50, type: "cps", value: 1 },
            megaPunch: { name: "Mega Punch", count: 0, baseCost: 500, type: "click", value: 10 },
          };
    } catch {
      return {
        punchBoost: { name: "Punch Strength", count: 0, baseCost: 15, type: "click", value: 1.5 },
        autoPunch: { name: "Auto-Puncher", count: 0, baseCost: 50, type: "cps", value: 1 },
        megaPunch: { name: "Mega Punch", count: 0, baseCost: 500, type: "click", value: 10 },
      };
    }
  });

  const [particles, setParticles] = useState([]);
  const idRef = useRef(0);

  // Save state
  useEffect(() => localStorage.setItem("nm67_money", money), [money]);
  useEffect(() => localStorage.setItem("nm67_perClick", perClick), [perClick]);
  useEffect(() => localStorage.setItem("nm67_cps", cps), [cps]);
  useEffect(() => localStorage.setItem("nm67_upgrades", JSON.stringify(upgrades)), [upgrades]);

  // Auto income (CPS)
  useEffect(() => {
    const t = setInterval(() => {
      if (cps > 0) setMoney((m) => +(m + cps / 10).toFixed(2));
    }, 100);
    return () => clearInterval(t);
  }, [cps]);

  // Particle cleanup
  useEffect(() => {
    const t = setInterval(() => {
      setParticles((p) => p.filter((pt) => Date.now() - pt.t < 800));
    }, 100);
    return () => clearInterval(t);
  }, []);

  function handlePunch(e) {
    const rect = e.currentTarget.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    spawnParticles(x, y);
    setMoney((m) => +(m + perClick).toFixed(2));

    // Click animation
    const el = e.currentTarget;
    el.classList.add("scale-95");
    setTimeout(() => el.classList.remove("scale-95"), 120);
  }

  function spawnParticles(x, y) {
    const list = Array.from({ length: 6 }, () => ({
      id: idRef.current++,
      x,
      y,
      r: Math.random() * 6 + 4,
      t: Date.now(),
      vx: (Math.random() - 0.5) * 6,
      vy: -Math.random() * 6,
    }));
    setParticles((p) => [...p, ...list]);
  }

  function getCost(base, count) {
    return Math.round(base * Math.pow(1.15, count));
  }

  function buyUpgrade(key) {
    const up = upgrades[key];
    const cost = getCost(up.baseCost, up.count);
    if (money < cost) return;

    setMoney((m) => +(m - cost).toFixed(2));
    setUpgrades((u) => ({
      ...u,
      [key]: { ...u[key], count: u[key].count + 1 },
    }));

    if (up.type === "click") {
      setPerClick((pc) => +(pc * up.value).toFixed(2));
    } else if (up.type === "cps") {
      setCps((c) => +(c + up.value).toFixed(2));
    }
  }

  function resetGame() {
    if (!window.confirm("Are you sure you want to reset NO MORE 67?")) return;
    setMoney(0);
    setPerClick(1);
    setCps(0);
    setUpgrades({
      punchBoost: { name: "Punch Strength", count: 0, baseCost: 15, type: "click", value: 1.5 },
